<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/gh/maketline/goodday/font/stylesheet.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <title>บันทึกการมาเยี่ยมชมโรงงาน</title>
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --accent-color: #4895ef;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --success-color: #4cc9f0;
      --warning-color: #f72585;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "line_seed_sans_th", sans-serif;
      font-weight: bold;
    }

    body {
      background-color: #f5f7fa;
      color: var(--dark-color);
      line-height: 1.6;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      border-top: 5px solid var(--primary-color);
    }

    h1 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 30px;
      font-size: 1.8rem;
      position: relative;
      padding-bottom: 15px;
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 4px;
      background: linear-gradient(to right, var(--primary-color), var(--accent-color));
      border-radius: 2px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
    }

    .month-year {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .nav-buttons button {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      margin: 0 5px;
      transition: all 0.3s ease;
    }

    .nav-buttons button:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 10px;
      text-align: center;
      font-weight: bold;
      color: var(--primary-color);
    }

    .weekday {
      padding: 10px;
    }

    .days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .day {
      position: relative;
      min-height: 100px;
      padding: 10px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
      cursor: pointer;
      border: 1px solid #e9ecef;
    }

    .day:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      border-color: var(--accent-color);
    }

    .day-number {
      font-weight: bold;
      margin-bottom: 5px;
      color: var(--dark-color);
    }

    .day.today {
      background-color: #e3f2fd;
      border: 2px solid var(--accent-color);
    }

    .day.visit-day {
      position: relative;
      overflow: hidden;
    }

    .event-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 5px;
      width: 100%;
      background-color: var(--warning-color);
      border-radius: 2px 2px 0 0;
    }

    .day.visit-day .total-visitors {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: var(--warning-color);
      color: white;
      font-size: 0.5rem;
      padding: 2px 5px;
      border-radius: 10px;
    }

    .day.other-month {
      color: #adb5bd;
      background-color: #f8f9fa;
    }

    #visitForm {
      margin: 30px auto;
      padding: 25px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      max-width: 600px;
      display: none;
      border-top: 5px solid var(--primary-color);
    }

    #visitForm h2 {
      color: var(--primary-color);
      margin-bottom: 20px;
      text-align: center;
      font-size: 1.8rem;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark-color);
    }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(72, 149, 239, 0.2);
    }

    .btn {
      display: inline-block;
      padding: 12px 25px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      text-align: center;
    }

    .btn:hover {
      background-color: var(--secondary-color);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
    }

    .btn-block {
      display: block;
      width: 100%;
    }

    #errorMsg {
      color: var(--warning-color);
      margin-top: 15px;
      text-align: center;
      font-size: 0.9rem;
    }

    .visit-details {
      margin-top: 5px;
      font-size: 0.8rem;
    }

    .visit-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3px;
      padding: 2px 5px;
      background-color: rgba(255, 255, 255, 0.7);
      border-radius: 3px;
    }

    .visit-name {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .visit-count {
      font-weight: bold;
      color: var(--warning-color);
    }

    .visit-details {
      max-height: 60px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--accent-color) rgba(0,0,0,0.1);
      margin-top: 3px;
      padding-right: 2px;
      font-size: 0.8rem;
    }

    .visit-details::-webkit-scrollbar {
      width: 3px;
    }

    .visit-details::-webkit-scrollbar-thumb {
      background-color: var(--accent-color);
      border-radius: 3px;
    }

    .visit-count-mobile {
      position: absolute;
      bottom: 2px;
      right: 2px;
      background-color: var(--warning-color);
      color: white;
      font-size: 0.6rem;
      padding: 1px 4px;
      border-radius: 10px;
    }

    .thumbnail {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
      cursor: pointer;
      margin: 2px;
    }

    .full-image-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .full-image {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
    }

    .close-button {
      position: absolute;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 24px;
      cursor: pointer;
    }

    /* Loading Animation */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      flex-direction: column;
      color: white;
      display: none;
    }

    .loader {
      width: 60px;
      height: 60px;
      border: 5px solid var(--warning-color);
      border-top: 5px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 1.2rem;
      font-weight: bold;
      letter-spacing: 1px;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: white;
      margin: 15% auto;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      max-width: 400px;
      border-top: 5px solid var(--primary-color);
    }

    .close-modal {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close-modal:hover {
      color: var(--warning-color);
    }

    /* Mobile Styles */
    @media (max-width: 600px) {
      .container {
        padding: 15px;
      }

      h1 {
        font-size: 1.6rem;
      }

      .day {
        min-height: 60px;
        padding: 3px;
        font-size: 0.8rem;
      }

      .day-number {
        font-size: 0.7rem;
        margin-bottom: 2px;
      }

      .visit-details {
        display: none;
      }

      .weekday {
        font-size: 0.7rem;
        padding: 5px 2px;
      }

      .month-year {
        font-size: 1.1rem;
      }

      .nav-buttons button {
        padding: 5px 8px;
        font-size: 0.8rem;
      }

      #visitForm {
        padding: 15px;
        margin: 15px auto;
      }

      .form-control {
        padding: 10px 12px;
      }

      .btn {
        padding: 10px 15px;
      }

      /* Horizontal Scroll for Records */
      .records-container {
        display: flex;
        overflow-x: auto;
        gap: 10px;
        padding: 10px;
        scrollbar-width: thin;
        scrollbar-color: var(--accent-color) rgba(0,0,0,0.1);
      }

      .record-card {
        flex: 0 0 auto;
        width: 250px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 10px;
        position: relative;
      }

      .record-card img {
        width: 100%;
        height: 80px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 10px;
        cursor: pointer;
      }

      .record-actions {
        display: flex;
        gap: 5px;
        margin-top: 10px;
      }

      .record-actions button {
        flex: 1;
        padding: 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        color: white;
      }

      .btn-edit {
        background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      }

      .btn-delete {
        background: linear-gradient(135deg, #f44336 0%, #c62828 100%);
      }

      /* Modal mobile styles */
      .modal-content {
        margin: 20% auto;
        width: 90%;
      }
    }

    @media (min-width: 601px) and (max-width: 900px) {
      .day {
        min-height: 80px;
        padding: 5px;
      }

      .visit-item {
        flex-direction: column;
      }

      .visit-name {
        white-space: normal;
        font-size: 0.7rem;
        margin-bottom: 2px;
      }

      .visit-count {
        font-size: 0.7rem;
      }
    }

    .btn-delete, .btn-edit {
      transition: all 0.2s ease;
    }

    .btn-delete:hover, .btn-edit:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .btn-delete:active, .btn-edit:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loader"></div>
    <div class="loading-text">กำลังโหลดข้อมูล...</div>
  </div>

  <div id="containerot" class="container">
    <h1>ปฏิทินลูกค้า</h1>

    <div class="calendar-header">
      <div class="month-year" id="monthYear">มกราคม 2023</div>
      <div class="nav-buttons">
        <button id="prevMonth"><</button>
        <button id="today">วันนี้</button>
        <button id="nextMonth">></button>
      </div>
    </div>

    <div class="weekdays">
      <div class="weekday">อา</div>
      <div class="weekday">จ</div>
      <div class="weekday">อ</div>
      <div class="weekday">พ</div>
      <div class="weekday">พฤ</div>
      <div class="weekday">ศ</div>
      <div class="weekday">ส</div>
    </div>

    <div class="days" id="calendar"></div>

    <div id="visitForm">
      <h2 id="formTitle">บันทึกการมาเยี่ยมชม</h2>
      <div class="form-group">
        <label for="companyName">ชื่อบริษัท</label>
        <input type="text" id="companyName" class="form-control" placeholder="กรอกชื่อบริษัท" required>
      </div>

      <div class="form-group">
        <label for="visitDate">วันที่เยี่ยมชม</label>
        <input type="date" id="visitDate" class="form-control" disabled>
      </div>

      <div class="form-group">
        <label for="endDate">ถึงวันที่</label>
        <input type="date" id="endDate" class="form-control" required>
      </div>

      <div class="form-group">
        <label for="customerCount">จำนวนลูกค้าที่เข้าเยี่ยมชม</label>
        <input type="number" id="customerCount" class="form-control" placeholder="กรอกจำนวนลูกค้า" required>
      </div>

      <div class="form-group">
        <label for="branch">สาขา</label>
        <select id="branch" class="form-control" required>
          <option value="">--เลือกสาขา--</option>
          <option value="CM1">CM1</option>
          <option value="CM2">CM2</option>
          <option value="CM1/CM2">CM1/CM2</option>
          <option value="Gofield">Gofield</option>
        </select>
      </div>

      <div class="form-group">
        <label for="photoLink">ลิงก์รูปภาพ</label>
        <input type="url" id="photoLink" class="form-control" placeholder="เพิ่มลิงก์รูปภาพ">
      </div>

      <div class="form-group">
        <label for="notes">อื่นๆ</label>
        <input type="text" id="notes" class="form-control" placeholder="เพิ่มรายละเอียด">
      </div>

      <div class="form-group">
        <label for="recorder">ผู้บันทึกข้อมูล</label>
        <input type="text" id="recorder" class="form-control" placeholder="กรอกชื่อผู้บันทึก" required>
      </div>

      <button id="saveBtn" class="btn btn-block">บันทึกข้อมูล</button>
      <p id="errorMsg"></p>
    </div>

    <div class="full-image-overlay" id="fullImageOverlay">
      <span class="close-button" id="closeImage">×</span>
      <img class="full-image" id="fullImage" src="">
    </div>

    <br><hr><br>
    <center><div class="footer">
      <h6 class="text-lg font-semibold" style="font-size: 12px;color:#4361ee;">
        <i class="far fa-copyright"></i> 2025 จัดทำโดย นายภาคภูมิ เรือนมูล
      </h6>
    </div></center>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <div id="loginForm">
        <h2 class="text-center text-2xl font-bold mb-6" style="color: var(--primary-color);">เข้าสู่ระบบ</h2>
        <div class="form-group">
          <label for="email">อีเมล</label>
          <input type="email" id="email" class="form-control" placeholder="กรอกอีเมล" required>
        </div>
        <div class="form-group">
          <label for="password">รหัสผ่าน</label>
          <input type="password" id="password" class="form-control" placeholder="กรอกรหัสผ่าน" required>
        </div>
        <button id="loginBtn" class="btn btn-block">เข้าสู่ระบบ</button>
        <button id="logoutBtn" class="btn btn-block" style="background-color: var(--warning-color); display: none;">ออกจากระบบ</button>
        <p id="loginError" class="text-center text-red-500 mt-4"></p>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // ตัวแปรหลัก
    let currentDate = new Date();
    let selectedDate = null;
    let visitRecords = [];
    let currentUser = null;
    let editRecordKey = null;

    // DOM Elements
    const calendarEl = document.getElementById('calendar');
    const monthYearEl = document.getElementById('monthYear');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const todayBtn = document.getElementById('today');
    const visitFormEl = document.getElementById('visitForm');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginErrorEl = document.getElementById('loginError');
    const containerEl = document.getElementById('containerot');
    const fullImageOverlay = document.getElementById('fullImageOverlay');
    const fullImage = document.getElementById('fullImage');
    const closeImage = document.getElementById('closeImage');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const formTitle = document.getElementById('formTitle');
    const loginModal = document.getElementById('loginModal');
    const closeModalBtn = document.querySelector('.close-modal');

    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDuek-870g_xTYbfXZTg824eU4c4WyvFf4",
      authDomain: "test-fe28a.firebaseapp.com",
      databaseURL: "https://test-fe28a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "test-fe28a",
      storageBucket: "test-fe28a.firebasestorage.app",
      messagingSenderId: "297402725045",
      appId: "1:297402725045:web:e9832657e3df5795c684fc",
      measurementId: "G-BJG2J0BF44"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // ฟังก์ชันเปิด/ปิดโมดอล
    function openLoginModal() {
      loginModal.style.display = 'block';
    }

    function closeLoginModal() {
      loginModal.style.display = 'none';
    }

    // Check authentication state
    auth.onAuthStateChanged(user => {
      currentUser = user;
      if (user) {
        closeLoginModal();
        logoutBtn.style.display = 'block';
        containerEl.classList.remove('hidden');
        fetchVisitRecords();
      } else {
        logoutBtn.style.display = 'none';
        containerEl.classList.remove('hidden');
        fetchVisitRecords();
        visitFormEl.style.display = 'none';
      }
    });

    // ฟังก์ชันล็อกอิน
    loginBtn.addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();

      if (!email || !password) {
        loginErrorEl.textContent = 'กรุณากรอกอีเมลและรหัสผ่าน';
        return;
      }

      try {
        await auth.signInWithEmailAndPassword(email, password);
        loginErrorEl.textContent = '';
        Swal.fire({
          position: 'center',
          icon: 'success',
          title: '<h4>เข้าสู่ระบบสำเร็จ</h4>',
          showConfirmButton: false,
          timer: 1500
        });
      } catch (error) {
        console.error("Login error:", error);
        loginErrorEl.textContent = 'อีเมลหรือรหัสผ่านไม่ถูกต้อง';
      }
    });

    // ฟังก์ชันออกจากระบบ
    logoutBtn.addEventListener('click', async () => {
      try {
        await auth.signOut();
        Swal.fire({
          position: 'center',
          icon: 'success',
          title: '<h4>ออกจากระบบสำเร็จ</h4>',
          showConfirmButton: false,
          timer: 1500
        });
      } catch (error) {
        console.error("Logout error:", error);
        Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถออกจากระบบได้', 'error');
      }
    });

    async function fetchVisitRecords() {
      loadingOverlay.style.display = 'flex';
      try {
        const snapshot = await database.ref('visitRecords').once('value');
        const records = snapshot.val() || {};

        visitRecords = Object.entries(records).map(([key, record]) => {
          const dateObj = new Date(record.visitDate);
          const thaiDate = new Date(dateObj.getTime() + (7 * 60 * 60 * 1000));

          return {
            key: key,
            visitDate: thaiDate.toISOString().split('T')[0],
            endDate: record.endDate || '',
            companyName: record.companyName || '',
            customerCount: record.customerCount || 0,
            branch: record.branch || '',
            photoLink: record.photoLink || '',
            notes: record.notes || '',
            recorder: record.recorder || ''
          };
        });

        loadingOverlay.style.display = 'none';
        containerEl.classList.remove("hidden");
        renderCalendar();
      } catch (error) {
        console.error("Error fetching visit records:", error);
        loadingOverlay.style.display = 'none';
        Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถดึงข้อมูลได้', 'error');
      }
    }

    function setupEventListeners() {
      prevMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        fetchVisitRecords();
      });

      nextMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        fetchVisitRecords();
      });

      todayBtn.addEventListener('click', () => {
        currentDate = new Date();
        fetchVisitRecords();
      });

      saveBtn.addEventListener('click', saveVisit);

      closeImage.addEventListener('click', () => {
        fullImageOverlay.style.display = 'none';
      });

      // Modal event listeners
      closeModalBtn.addEventListener('click', closeLoginModal);
      window.addEventListener('click', (e) => {
        if (e.target === loginModal) {
          closeLoginModal();
        }
      });
    }

    function renderCalendar() {
      calendarEl.innerHTML = '';

      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      const monthNames = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน",
                         "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
      monthYearEl.textContent = `${monthNames[month]} ${year}`;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startDay = firstDay.getDay();

      for (let i = 0; i < startDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'day other-month';
        calendarEl.appendChild(emptyDay);
      }

      const today = new Date();
      const isMobile = window.innerWidth <= 600;

      for (let day = 1; day <= daysInMonth; day++) {
        const dayEl = document.createElement('div');
        dayEl.className = 'day';
        const dateStr = formatDate(new Date(year, month, day));

        if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
          dayEl.classList.add('today');
        }

        const dayRecords = visitRecords.filter(record => {
          const startDate = new Date(record.visitDate);
          const endDate = new Date(record.endDate);
          const currentDay = new Date(dateStr);
          return currentDay >= startDate && currentDay <= endDate;
        });

        dayEl.innerHTML = `<div class="day-number">${day}</div>`;

        if (dayRecords.length > 0) {
          dayEl.classList.add('visit-day');
          const eventBar = document.createElement('div');
          eventBar.className = 'event-bar';
          dayEl.appendChild(eventBar);

          if (isMobile) {
            const visitCount = document.createElement('div');
            visitCount.className = 'visit-count-mobile';
            visitCount.textContent = `${dayRecords.length} กรุ๊ป`;
            dayEl.appendChild(visitCount);
          } else {
            const visitDetails = document.createElement('div');
            visitDetails.className = 'visit-details';

            dayRecords.forEach(record => {
              const visitItem = document.createElement('div');
              visitItem.className = 'visit-item';
              visitItem.innerHTML = `
                <span class="visit-name">${record.companyName}</span>
                <span class="visit-count">${record.customerCount} คน</span>
              `;
              visitDetails.appendChild(visitItem);
            });

            dayEl.appendChild(visitDetails);
          }
        }

        dayEl.addEventListener('click', () => selectDate(new Date(year, month, day)));
        calendarEl.appendChild(dayEl);
      }

      const totalCells = Math.ceil((daysInMonth + startDay) / 7) * 7;
      const remainingCells = totalCells - (daysInMonth + startDay);

      for (let i = 0; i < remainingCells; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'day other-month';
        calendarEl.appendChild(emptyDay);
      }
    }

    window.addEventListener('resize', () => {
      renderCalendar();
    });

    function formatDate(date) {
      const thaiDate = new Date(date.getTime() + (7 * 60 * 60 * 1000));
      const yyyy = thaiDate.getFullYear();
      const mm = String(thaiDate.getMonth() + 1).padStart(2, '0');
      const dd = String(thaiDate.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    async function selectDate(date) {
      selectedDate = date;
      const dateStr = formatDate(date);
      const existingRecords = visitRecords.filter(record => {
        const startDate = new Date(record.visitDate);
        const endDate = new Date(record.endDate);
        const currentDay = new Date(dateStr);
        return currentDay >= startDate && currentDay <= endDate;
      });
      const hasRecords = existingRecords.length > 0;
      const isMobile = window.innerWidth <= 600;

      let recordsContent = '';
      if (hasRecords) {
        if (isMobile) {
          recordsContent = `
            <div class="records-container">
              ${existingRecords.map((record, index) => `
                <div class="record-card">
                  ${record.photoLink ? `<img src="${record.photoLink}" class="record-img" data-full="${record.photoLink}" alt="Visit photo">` : '<div style="height: 80px; background: #eee; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #666;">ไม่มีรูป</div>'}
                  <div style="font-size: 0.8rem; margin-bottom: 5px;">
                    <strong>${record.companyName}</strong>
                  </div>
                  <div style="font-size: 0.7rem; color: #666;">
                    <i class="fas fa-users"></i> ${record.customerCount} คน
                  </div>
                  <div style="font-size: 0.7rem; color: #666;">
                    <i class="fas fa-map-marker-alt"></i> ${record.branch}
                  </div>
                  ${currentUser ? `
                    <div class="record-actions">
                      <button class="btn-edit" data-key="${record.key}" data-date="${dateStr}">
                        <i class="fas fa-edit"></i> แก้ไข
                      </button>
                      <button class="btn-delete" data-key="${record.key}" data-date="${dateStr}">
                        <i class="fas fa-trash-alt"></i> ลบ
                      </button>
                    </div>
                  ` : ''}
                </div>
              `).join('')}
            </div>`;
        } else {
          recordsContent = `
            <table style="width: 100%; border-collapse: separate; border-spacing: 0; background: white;">
              <tbody>
                ${existingRecords.map((record, index) => `
                  <tr style="background-color: ${index % 2 === 0 ? '#f8f9fe' : 'white'}; font-size: 14px;">
                    <td style="padding: 14px 20px; border-bottom: 1px solid #f0f0f0;">
                      <i class="fas fa-building" style="margin-right: 8px; color: #666;"></i> ${record.companyName}
                    </td>
                    <td style="padding: 14px 20px; border-bottom: 1px solid #f0f0f0;">
                      <i class="fas fa-users" style="margin-right: 8px; color: #666;"></i> ${record.customerCount} คน
                    </td>
                    <td style="padding: 14px 20px; border-bottom: 1px solid #f0f0f0;">
                      <i class="fas fa-map-marker-alt" style="margin-right: 8px; color: #666;"></i> ${record.branch}
                    </td>
                    <td style="padding: 14px 20px; border-bottom: 1px solid #f0f0f0;">
                      ${record.photoLink ? `<img src="${record.photoLink}" class="thumbnail" data-full="${record.photoLink}" alt="Visit photo">` : 'ไม่มีรูป'}
                    </td>
                    <td style="padding: 14px 20px; border-bottom: 1px solid #f0f0f0; text-align: center;">
                      ${currentUser ? `
                        <button class="btn-edit" data-key="${record.key}" data-date="${dateStr}" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 5px;">
                          <i class="fas fa-edit" style="margin-right: 4px;"></i> แก้ไข
                        </button>
                        <button class="btn-delete" data-key="${record.key}" data-date="${dateStr}" style="background: linear-gradient(135deg, #ff5e5e 0%, #d32f2f 100%); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                          <i class="fas fa-trash-alt" style="margin-right: 4px;"></i> ลบ
                        </button>
                      ` : ''}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            <div style="padding: 15px 25px; background: #f9f9ff; border-top: 1px solid #eee; text-align: right; font-size: 14px; color: #666;">
              <i class="fas fa-info-circle" style="margin-right: 6px;"></i>
              รวมทั้งหมด ${existingRecords.length} กรุ๊ป
            </div>`;
        }
      }

      const titleText = hasRecords ? 'มีบันทึกการเยี่ยมชม <br>ในวันที่ ' : 'ไม่มีบันทึกการเยี่ยมชม <br>ในวันที่ ';
      const dateDisplay = `
        <div style="padding: 18px 25px; background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%); color: white; font-size: 20px; font-weight: 600;">
          ${titleText}${date.getDate()} ${getThaiMonthName(date.getMonth())} ${date.getFullYear() + 543}
        </div>
      `;

      await Swal.fire({
        html: `
          <div style="text-align: left; margin: 0 auto; max-width: 800px; font-family: 'Kanit', 'Prompt', sans-serif; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); border-radius: 16px; overflow: hidden; background: white; transition: all 0.3s ease;">
            ${dateDisplay}
            ${hasRecords ? recordsContent : `
              <div style="text-align: center; padding: 40px 30px; font-size: 16px; color: #666;">
                <i class="far fa-folder-open" style="font-size: 40px; margin-bottom: 15px; color: #ccc;"></i>
                <div>ไม่พบข้อมูลการเยี่ยมชมในวันที่เลือก</div>
              </div>
            `}
            <div style="padding: 10px; border-top: 1px solid #eee; display: flex; justify-content: center; gap: 12px; font-size: 14px;">
              <button id="btn-book" class="swal2-confirm swal2-styled"
                style="background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); border: none; padding: 10px 24px; border-radius: 8px; font-weight: 500; box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3); transition: all 0.2s ease;">
                <i class="fas fa-plus-circle" style="margin-right: 8px;"></i> บันทึกการเยี่ยม
              </button>
              <button id="btn-close" class="swal2-confirm swal2-styled"
                style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); border: none; padding: 10px 24px; border-radius: 8px; font-weight: 500; box-shadow: 0 2px 6px rgba(244, 67, 54, 0.3); transition: all 0.2s ease;">
                <i class="fas fa-times-circle" style="margin-right: 8px;"></i> ปิด
              </button>
            </div>
          </div>
        `,
        showConfirmButton: false,
        showCloseButton: false,
        allowOutsideClick: true,
        background: 'transparent',
        backdrop: 'rgba(128, 128, 128,0.9)',
        customClass: {
          popup: 'swal2-no-box'
        },
        didOpen: () => {
          document.getElementById("btn-close")?.addEventListener("click", () => Swal.close());
          document.getElementById("btn-book")?.addEventListener("click", () => {
            Swal.close();
            if (currentUser) {
              editRecordKey = null;
              formTitle.textContent = 'บันทึกการมาเยี่ยมชม';
              setTimeout(() => showVisitForm(dateStr), 300);
            } else {
              openLoginModal();
              Swal.fire('กรุณาเข้าสู่ระบบ', 'คุณต้องเข้าสู่ระบบเพื่อบันทึกข้อมูล', 'warning');
            }
          });
          if (currentUser) {
            document.querySelectorAll('.btn-delete').forEach(btn => {
              btn.addEventListener('click', async (e) => {
                const recordKey = e.target.closest('.btn-delete').dataset.key;
                const recordDate = e.target.closest('.btn-delete').dataset.date;
                await deleteRecord(recordKey, recordDate);
              });
            });
            document.querySelectorAll('.btn-edit').forEach(btn => {
              btn.addEventListener('click', async (e) => {
                const recordKey = e.target.closest('.btn-edit').dataset.key;
                const recordDate = e.target.closest('.btn-edit').dataset.date;
                const record = visitRecords.find(r => r.key === recordKey);
                editRecordKey = recordKey;
                formTitle.textContent = 'แก้ไขการมาเยี่ยมชม';
                Swal.close();
                setTimeout(() => showVisitForm(recordDate, record), 300);
              });
            });
          }
          document.querySelectorAll('.thumbnail, .record-img').forEach(img => {
            img.addEventListener('click', () => {
              fullImage.src = img.dataset.full;
              fullImageOverlay.style.display = 'flex';
              Swal.close();
            });
          });
        }
      });
    }

    function closeList() {
      Swal.close();
    }

    async function deleteRecord(recordKey, dateStr) {
      if (!currentUser) {
        Swal.fire('กรุณาเข้าสู่ระบบ', 'คุณต้องเข้าสู่ระบบเพื่อลบข้อมูล', 'warning');
        openLoginModal();
        return;
      }

      try {
        const result = await Swal.fire({
          title: 'ยืนยันการลบ',
          text: 'คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'ลบ',
          cancelButtonText: 'ยกเลิก'
        });

        if (result.isConfirmed) {
          await database.ref(`visitRecords/${recordKey}`).remove();
          visitRecords = visitRecords.filter(record => record.key !== recordKey);
          Swal.fire({
            position: 'center',
            icon: 'success',
            title: '<h4>ลบข้อมูลสำเร็จ</h4>',
            showConfirmButton: false,
            allowOutsideClick: false,
            timer: 1500
          }).then(() => {
            fetchVisitRecords();
            selectDate(new Date(dateStr));
          });
        }
      } catch (error) {
        console.error("Error deleting record:", error);
        Swal.fire('เกิดข้อผิดพลาด!', 'ไม่สามารถลบรายการได้', 'error');
      }
    }

    function showVisitForm(dateStr, existingRecord = null) {
      if (!currentUser) {
        Swal.fire('กรุณาเข้าสู่ระบบ', 'คุณต้องเข้าสู่ระบบเพื่อบันทึกข้อมูล', 'warning');
        openLoginModal();
        return;
      }

      document.getElementById('visitDate').value = dateStr;
      visitFormEl.style.display = 'block';
      document.getElementById('errorMsg').textContent = '';

      if (existingRecord) {
        document.getElementById('companyName').value = existingRecord.companyName || '';
        document.getElementById('endDate').value = existingRecord.endDate || '';
        document.getElementById('customerCount').value = existingRecord.customerCount || '';
        document.getElementById('branch').value = existingRecord.branch || '';
        document.getElementById('photoLink').value = existingRecord.photoLink || '';
        document.getElementById('notes').value = existingRecord.notes || '';
        document.getElementById('recorder').value = existingRecord.recorder || '';
      } else {
        document.getElementById('companyName').value = '';
        document.getElementById('endDate').value = '';
        document.getElementById('customerCount').value = '';
        document.getElementById('branch').value = '';
        document.getElementById('photoLink').value = '';
        document.getElementById('notes').value = '';
        document.getElementById('recorder').value = '';
      }

      visitFormEl.scrollIntoView({ behavior: 'smooth' });
    }

    function getThaiMonthName(monthIndex) {
      const monthNames = [
        "มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน",
        "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"
      ];
      return monthNames[monthIndex];
    }

    async function saveVisit() {
      if (!currentUser) {
        Swal.fire('กรุณาเข้าสู่ระบบ', 'คุณต้องเข้าสู่ระบบเพื่อบันทึกข้อมูล', 'warning');
        openLoginModal();
        return;
      }

      const companyName = document.getElementById('companyName').value.trim();
      const visitDate = document.getElementById('visitDate').value;
      const endDate = document.getElementById('endDate').value;
      const customerCount = document.getElementById('customerCount').value;
      const branch = document.getElementById('branch').value;
      const photoLink = document.getElementById('photoLink').value.trim();
      const notes = document.getElementById('notes').value.trim();
      const recorder = document.getElementById('recorder').value.trim();

      if (!companyName || !visitDate || !endDate || !customerCount || !branch || !recorder) {
        document.getElementById('errorMsg').textContent = 'กรุณากรอกข้อมูลให้ครบถ้วน';
        return;
      }

      if (endDate < visitDate) {
        document.getElementById('errorMsg').textContent = 'ถึงวันที่ต้องมากกว่าหรือเท่ากับวันที่เยี่ยมชม';
        return;
      }

      if (customerCount <= 0) {
        document.getElementById('errorMsg').textContent = 'จำนวนลูกค้าต้องมากกว่า 0';
        return;
      }

      const visitRecord = {
        visitDate,
        endDate,
        companyName,
        customerCount,
        branch,
        photoLink,
        notes,
        recorder
      };

      await saveToGoogleSheets(visitRecord);
      visitFormEl.style.display = 'none';

      Swal.fire({
        position: 'center',
        icon: 'success',
        title: `<h4>${editRecordKey ? 'แก้ไข' : 'บันทึก'}ข้อมูลสำเร็จ</h4>`,
        showConfirmButton: false,
        allowOutsideClick: false,
        timer: 1500
      }).then(() => {
        editRecordKey = null;
        formTitle.textContent = 'บันทึกการมาเยี่ยมชม';
        return fetchVisitRecords();
      });
    }

    async function saveToGoogleSheets(data) {
      try {
        const recordKey = editRecordKey || database.ref().child('visitRecords').push().key;

        await database.ref(`visitRecords/${recordKey}`).set({
          visitDate: data.visitDate,
          endDate: data.endDate,
          companyName: data.companyName,
          customerCount: data.customerCount,
          branch: data.branch,
          photoLink: data.photoLink,
          notes: data.notes,
          recorder: data.recorder
        });

        console.log("บันทึกข้อมูลเรียบร้อย");
        return { status: "success" };
      } catch (error) {
        console.error("บันทึกข้อมูลไม่สำเร็จ:", error);
        Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกข้อมูลได้', 'error');
        throw error;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      fetchVisitRecords();
    });
  </script>
</body>
</html>